<html>
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
    <script type="text/javascript">
      var CLIENT_ID = '425474108915-9dr4mc0pikee1n1hr5ia0fusvrg5460o.apps.googleusercontent.com';
      var SCOPES = 'https://www.googleapis.com/auth/drive.appdata';

      /**
       * Called when the client library is loaded to start the auth flow.
       */
      function handleClientLoad() {
        window.setTimeout(checkAuth, 1);
      }

      /**
       * Check if the current user has authorized the application.
       */
      function checkAuth() {
        gapi.auth.authorize(
            {'client_id': CLIENT_ID, 'scope': SCOPES, 'immediate': true},
            handleAuthResult);
      }

      /**
       * Called when authorization server replies.
       *
       * @param {Object} authResult Authorization result.
       */
      function handleAuthResult(authResult) {
        var authButton = document.getElementById('authorizeButton');
        var filePicker = document.getElementById('filePicker');
        authButton.style.display = 'none';
        filePicker.style.display = 'none';
        if (authResult && !authResult.error) {
          // Access token has been successfully retrieved, requests can be sent to the API.
          filePicker.style.display = 'block';
          filePicker.onchange = uploadFile;
        } else {
          // No access token could be retrieved, show the button to start the authorization flow.
          authButton.style.display = 'block';
          authButton.onclick = function() {
              gapi.auth.authorize(
                  {'client_id': CLIENT_ID, 'scope': SCOPES, 'immediate': false},
                  handleAuthResult);
          };
        }
      }

      /**
       * Start the file upload.
       *
       * @param {Object} evt Arguments from the file selector.
       */
      function uploadFile(evt) {
        gapi.client.load('drive', 'v2', function() {
          var file = evt.target.files[0];
          // insertFile(file);
          insertFile2();
        });
      }


      function insertFile2(callback) {
          var folderID = getApplicationDataFolderMetadata();
          console.log(folderID);
        //   gapi.client.load('drive', 'v2', function() {
        //   var request = gapi.client.request({
        //         'path': '/drive/v2/files/',
        //         'method': 'POST',
        //         'body':{
        //             "title" : "test.txt",
        //             "description" : "Some",
        //             "parents": [{'id': folderID}]
        //         }
        //     });
        //     request.execute(function(resp) { console.log(resp); gd_updateFile(resp.id, folderID, "lalala")});
        // });
      }

      function getApplicationDataFolderMetadata() {
        var request = gapi.client.drive.files.get({
          'fileId': 'appdata'
        });
        var appdataFoldID;
        request.execute(function(resp) {
          appdataFoldID = resp.id;
        });
        console.log(appdataFoldID);
        return appdataFoldID;
      }

      function gd_updateFile(fileId, folderID, text, callback) {

        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";

        var contentType = "text/html";
        var metadata = {'mimeType': contentType, 'parents': [{'id': folderID}]};

        var multipartRequestBody =
            delimiter +  'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(metadata) +
            delimiter + 'Content-Type: ' + contentType + '\r\n' + '\r\n' +
            text +
            close_delim;

        if (!callback) { callback = function(file) { console.log("Update Complete ",file) }; }

        gapi.client.request({
            'path': '/upload/drive/v2/files/'+fileId,
            'method': 'PUT',
            'params': {'fileId': fileId, 'uploadType': 'multipart'},
            'headers': {'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'},
            'body': multipartRequestBody,
            callback:callback,
        });
      }
    </script>
    <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>
  </head>
  <body>
    <!--Add a file picker for the user to start the upload process -->
    <input type="file" id="filePicker" style="display: none" />
    <input type="button" id="authorizeButton" style="display: none" value="Authorize" />
  </body>
</html>
